package fixtory

const fixtoryFileTpl = `
// Code generated by {{ .GeneratorName }}; DO NOT EDIT.

package {{ .PackageName }}

import (
	"testing"

	"github.com/k-yomo/fixtory"
{{- range .ImportPackages }}
	{{ . }}
{{- end}}
)

{{ .Body }}
`

const factoryTpl = `
{{ $lowerStructName := .StructName | ToLower }}
{{ $factoryInterface := printf "%s%s" .StructName "Factory" }}
{{ $builderInterface := printf "%s%s" .StructName "Builder" }}
{{ $traitType := printf "%s%s" .StructName "Trait" }}
{{ $factory := printf "%s%s" $lowerStructName "Factory" }}
{{ $builder := printf "%s%s" $lowerStructName "Builder" }}
{{ $fieldType := printf "%s%s" .StructName "Field" }}

type {{ $traitType }} struct {
	{{ .StructName }} {{ .Struct }}
	Zero []{{ $fieldType }}
}

type {{ $factoryInterface }} interface {
	NewBuilder(bluePrint {{ .StructName }}BluePrintFunc, traits ...{{ $traitType }}) {{ $builderInterface }}
	OnBuild(onBuild func(t *testing.T, {{ $lowerStructName }} *{{ .Struct }}))
	OnInsert(onInsert func(t *testing.T, {{ $lowerStructName }} *{{ .Struct }}))
	Reset()
}

type {{ $builderInterface }} interface {
	EachParam({{ $lowerStructName }}Params ...{{ $traitType }}) {{ $builderInterface }}
	Set({{ $lowerStructName}} {{ .Struct }}) {{ $builderInterface }}
	Zero({{ $lowerStructName }}Fields ...{{ $fieldType }}) {{ $builderInterface }}
	ResetAfter() {{ $builderInterface }}

	Build() *{{ .Struct }}
	Build2() (*{{ .Struct }}, *{{ .Struct }})
	Build3() (*{{ .Struct }}, *{{ .Struct }}, *{{ .Struct }})
	BuildList(n int) []*{{ .Struct }}
	Insert() *{{ .Struct }}
	InsertList(n int) []*{{ .Struct }}
}

type {{ .StructName }}BluePrintFunc func(i int, last {{ .Struct }}) {{ .Struct }}

type {{ $fieldType }} string

const (
{{- range .FieldNames }}
	{{ $.StructName }}{{ . }}Field {{ $fieldType }} = "{{ . }}"
{{- end}}
)

type {{ $factory }} struct {
	t       *testing.T
	factory *fixtory.Factory
}

type {{ $builder }} struct {
	t       *testing.T
	builder *fixtory.Builder
}

func New{{ .StructName }}Factory(t *testing.T) {{ $factoryInterface }} {
	t.Helper()

	return &{{ $factory }}{t: t, factory: fixtory.NewFactory(t, {{ .Struct }}{})}
}

func (uf *{{ $factory }}) NewBuilder(bluePrint {{ .StructName }}BluePrintFunc, traits ...{{ $traitType }}) {{ $builderInterface }} {
	uf.t.Helper()

	var bp fixtory.BluePrintFunc
	if bluePrint != nil {
		bp = func(i int, last interface{}) interface{} { return bluePrint(i, last.({{ .Struct }})) }
	}

	traitStructs := make([]{{ .Struct }}, len(traits))
	traitZeroes := make([][]string, len(traits))

	for i := range traits {
		traitStructs[i] = traits[i].{{ .StructName }}

		fields := make([]string, 0, len(traits[i].Zero))
		for _, f := range traits[i].Zero {
			fields = append(fields, string(f))
		}
		traitZeroes[i] = fields
	}

	builder := uf.factory.NewBuilder(bp, fixtory.ConvertToInterfaceArray(traitStructs), traitZeroes)
	return &{{ $builder }}{t: uf.t, builder: builder}
}

func (uf *{{ $factory }}) OnInsert(onInsert func(t *testing.T, {{ $lowerStructName }} *{{ .Struct }})) {
	uf.t.Helper()

	uf.factory.OnInsert = func(t *testing.T, v interface{}) { onInsert(t, v.(*{{ .Struct }})) }
}

func (uf *{{ $factory }}) OnBuild(onBuild func(t *testing.T, {{ $lowerStructName }} *{{ .Struct }})) {
	uf.t.Helper()

	uf.factory.OnBuild = func(t *testing.T, v interface{}) { onBuild(t, v.(*{{ .Struct }})) }
}

func (uf *{{ $factory }}) Reset() {
	uf.t.Helper()

	uf.factory.Reset()
}

func (ub *{{ $builder }}) Set({{ $lowerStructName }} {{ .Struct }}) {{ $builderInterface }} {
	ub.t.Helper()

	ub.builder = ub.builder.Set({{ $lowerStructName }})
	return ub
}

func (ub *{{ $builder }}) Zero({{ $lowerStructName }}Fields ...{{ $fieldType }}) {{ $builderInterface }} {
	ub.t.Helper()

	fields := make([]string, 0, len({{ $lowerStructName }}Fields))
	for _, f := range {{ $lowerStructName }}Fields {
		fields = append(fields, string(f))
	}

	ub.builder = ub.builder.Zero(fields...)
	return ub
}
func (ub *{{ $builder }}) ResetAfter() {{ $builderInterface }} {
	ub.t.Helper()

	ub.builder = ub.builder.ResetAfter()
	return ub
}

func (ub *{{ $builder }}) EachParam({{ $lowerStructName }}Params ...{{ $traitType }}) {{ $builderInterface }} {
	ub.t.Helper()

	traitStructs := make([]{{ .Struct }}, len({{ $lowerStructName }}Params))
	traitZeroes := make([][]string, len({{ $lowerStructName }}Params))

	for i := range {{ $lowerStructName }}Params {
		traitStructs[i] = {{ $lowerStructName }}Params[i].{{ .StructName }}

		fields := make([]string, 0, len({{ $lowerStructName }}Params[i].Zero))
		for _, f := range {{ $lowerStructName }}Params[i].Zero {
			fields = append(fields, string(f))
		}
		traitZeroes[i] = fields
	}

	ub.builder = ub.builder.EachParam(fixtory.ConvertToInterfaceArray(traitStructs), traitZeroes)
	return ub
}

func (ub *{{ $builder }}) Build() *{{ .Struct }} {
	ub.t.Helper()

	return ub.builder.Build().(*{{ .Struct }})
}

func (ub *{{ $builder }}) Build2() (*{{ .Struct }}, *{{ .Struct }}) {
	ub.t.Helper()

	list := ub.BuildList(2)
	return list[0], list[1]
}

func (ub *{{ $builder }}) Build3() (*{{ .Struct }}, *{{ .Struct }}, *{{ .Struct }}) {
	ub.t.Helper()

	list := ub.BuildList(3)
	return list[0], list[1], list[2]
}

func (ub *{{ $builder }}) BuildList(n int) []*{{ .Struct }} {
	ub.t.Helper()

	list := make([]*{{ .Struct }}, 0, n)
	for _, v := range ub.builder.BuildList(n) {
		list = append(list, v.(*{{ .Struct }}))
	}
	return list
}

func (ub *{{ $builder }}) Insert() *{{ .Struct }} {
	ub.t.Helper()

	return ub.builder.Insert().(*{{ .Struct }})
}

func (ub *{{ $builder }}) InsertList(n int) []*{{ .Struct }} {
	ub.t.Helper()

	list := make([]*{{ .Struct }}, 0, n)
	for _, v := range ub.builder.InsertList(n) {
		list = append(list, v.(*{{ .Struct }}))
	}
	return list
}
`
